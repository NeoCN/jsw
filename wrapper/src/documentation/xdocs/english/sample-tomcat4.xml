<?xml version="1.0"?>

<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN" "../dtd/docbook/4.1.2/docbookx.dtd">

<!-- ********************************************************************
     $Id$
     ******************************************************************** -->

<chapter id="sample-jboss">
 
    <title>Tomcat 4 Integration Sample</title> 

    <section>
        <title>How to integrate the Wrapper with Tomcat 4</title>
        <para>
            Tomcat is normally run by executing startup.bat or startup.sh script to launch
            the server and then executing shutdown.bat or shutdown.sh to stop the server.
            This type of application is what the WrapperStartStopApp helper class was
            designed for.
        </para>
        <section>
            <title>Installing the Wrapper files</title>
            <para>
                Download the latest version of the Wrapper and uncompress the archive into
                the directory of your choice.  Do the same with Tomcat.
            </para>
            <section>
                <title>Windows files</title>
                <para>
                    Copy the Wrapper.exe file from the {wrapper.home}/bin directory
                    into the {tomcat.home}/bin directory.  Template batch files are
                    available in {wrapper.home}/src/bin.  Copy the files App.bat.in,
                    InstallApp-NT.bat.in and UninstallApp-NT.bat.in into the
                    {tomcat.home}/bin directory, renaming them as follows:
                    Tomcat.bat, InstallTomcat-NT.bat, and UninstallTomcat-NT.bat.
                </para>
                <para>
                    Next, copy the required library files, Wrapper.DLL and wrapper.jar,
                    from the {wrapper.home}/lib directory into the {tomcat.home}/lib
                    directory.
                </para>
                <para>
                    Finally, copy the template wrapper configuration file wrapper.conf.in
                    from the {wrapper.home}/src/conf directory into the
                    {tomcat.home}/conf directory, renaming it to wrapper.conf.  We will
                    go over required modifications to wrapper.conf below.
                </para>
            </section>
            <section>
                <title>Linux / Solaris files</title>
                <para>
                    Copy the wrapper and realpath binaries from the {wrapper.home}/bin
                    directory into the {tomcat.home}/bin directory.  Copy the template
                    script file from the {wrapper.home}/src/bin directory into the
                    {tomcat.home}/bin directory, renaming it to tomcat.sh.  There are
                    two script files available.  The first, bash.script.in should usually
                    be used for Linux.  sh.script.in should be used for Solaris.
                    Make sure that the executable permission is set for all 3 files.
                </para>
                <para>
                    Edit the tomcat.sh file.  Towards the top of the file, you will find
                    two tokens which need to be replaced.  Replace the token "@app.name@"
                    with "tomcat", and "@app.long.name@" with "Tomcat 4 Server".  No
                    other changes should be necessary.
                </para>
                <para>
                    Next, copy the required library files, libwrapper.so and wrapper.jar,
                    from the {wrapper.home}/lib directory into the {tomcat.home}/lib
                    directory.
                </para>
                <para>
                    Finally, copy the template wrapper configuration file wrapper.conf.in
                    from the {wrapper.home}/src/conf directory into the
                    {tomcat.home}/conf directory, renaming it to wrapper.conf.  We will
                    go over required modifications to wrapper.conf below.
                </para>
            </section>
        </section>
        <section>
            <title>Setting up the wrapper.conf file</title>
            <para>
                The scripts that come with Tomcat are a bit complicated so that they will
                work under all circumstances.  In order to figure out how to configure
                the Wrapper to launch Tomcat.  You need to first figure out what the
                actual command is that launches Tomcat.  You can do this on Windows by
                commenting out the @echo off at the top of the batch file.  The same can
                be done on unix by echoing the command to the console just before it is
                executed..
            </para>
            <para>
                On windows, the command used to launch Tomcat is as follows (The command
                is actually all on one line):
                <programlisting format="linespecific">"D:\Sun\j2sdk1.4.0\bin\java"
  -Djava.endorsed.dirs="..\bin;..\common\lib"
  -classpath "D:\Sun\j2sdk1.4.0\lib\tools.jar;..\bin\bootstrap.jar"
  -Dcatalina.base=".." -Dcatalina.home=".." -Djava.io.tmpdir="..\temp"
  org.apache.catalina.startup.Bootstrap  start</programlisting>
                It turns out that the shutdown script is exactly the same command.  The
                only difference is that the application parameter "start" is replaced
                with "stop".
                <programlisting format="linespecific">"D:\Sun\j2sdk1.4.0\bin\java"
  -Djava.endorsed.dirs="..\bin;..\common\lib"
  -classpath "D:\Sun\j2sdk1.4.0\lib\tools.jar;..\bin\bootstrap.jar"
  -Dcatalina.base=".." -Dcatalina.home=".." -Djava.io.tmpdir="..\temp"
  org.apache.catalina.startup.Bootstrap  stop</programlisting>
                The script resolves all absolute paths.  To make this example more
                portable, we will modify the absolute paths to be relative to the bin
                directory, where the Wrapper binary is located.  We will also assume
                that java can be found on the system path.
            </para>
            <para>
                Breaking up the commands above, there are several things to look for.
                The first is the command used to launch the JVM.  If the above command,
                this is "D:\Sun\j2sdk1.4.0\bin\java".  Assume that the java command is
                available on the path, the following property needs to be set in the
                wrapper.conf file:
                <programlisting format="linespecific">wrapper.java.command=java</programlisting>
            </para>
            <para>
                The next step is to setup the classpath.  To make the configuration
                portable, the Wrapper requires that each classpath element be set as a
                different property. It is also necessary to include the wrapper.jar
                file.  If you are using JSP, then Tomcat requires that the tools.jar
                file, included with the JDK, be included in the classpath as well.
                You can either set the classpath to point to the location of the jar
                in the JDK, or copy it into tomcat's tools directory.  Here we assume
                the later.  The classpath should be set as follows in the wrapper.conf
                file:
                <programlisting format="linespecific">wrapper.java.classpath.1=../lib/wrapper.jar
wrapper.java.classpath.2=../lib/tools.jar
wrapper.java.classpath.3=../bin/bootstrap.jar</programlisting>
            </para>
            <para>
                The Wrapper will need to be able to locate its native library.  This
                should already be set in the default wrapper.conf file, but make sure
                that the following property is set:
                <programlisting format="linespecific">wrapper.java.library.path=../lib</programlisting>
            </para>
            <para>
                Tomcat requires a number of properties be set when the JVM is launched.
                These are set as follows:
                <programlisting format="linespecific">wrapper.java.additional.1=-Djava.endorsed.dirs="../bin;../common/endorsed"
wrapper.java.additional.2=-Dcatalina.base=".."
wrapper.java.additional.3=-Dcatalina.home=".."
wrapper.java.additional.4=-Djava.io.tmpdir="../temp"</programlisting>
            </para>
            <para>
                Next the class used to launch Tomcat must be specified.  In the commands
                above, this is org.apache.catalina.startup.Bootstrap.  However we will
                be relying on a helper class to control the life cycle of Tomcat.  Set
                the main class as follows:
                <programlisting format="linespecific">wrapper.java.mainclass=com.silveregg.wrapper.WrapperStartStopApp</programlisting>
                The WrapperStartStopApp still needs to be told how to start and stop
                Tomcat.  This is done by passing parameters to the class when it is
                started.  Set the application parameters as follows:
                <programlisting format="linespecific">wrapper.app.parameter.1=org.apache.catalina.startup.Bootstrap
wrapper.app.parameter.2=1
wrapper.app.parameter.3=start
wrapper.app.parameter.4=org.apache.catalina.startup.Bootstrap
wrapper.app.parameter.5=true
wrapper.app.parameter.6=1
wrapper.app.parameter.7=stop</programlisting>
                The Bootstrap class is used to both start and stop Tomcat.  In each case,
                a single parameter is passed in. "start" to start Tomcat, and "stop" to
                stop it.  When stopping Tomcat, the "true" flag specifies that the JVM
                should not exit until all non daemon threads have completed.
            </para>
            <para>
                The last step is to set the name of the pid file to use, for unix
                systems, and the name and description of the NT Service, for Windows
                systems:
                <programlisting format="linespecific">wrapper.pidfile=/var/run/tomcat.pid
wrapper.ntservice.name=tomcat
wrapper.ntservice.displayname=Tomcat 4 Server
wrapper.ntservice.description=Tomcat 4 Server</programlisting>
                If you applications make use of a database, then on Windows systems, you
                should also make sure that the database is always started before Tomcat
                when running as a service:
                <programlisting format="linespecific">wrapper.ntservice.dependency.1=MySQL</programlisting>
            </para>
        </section>
        <section>
            <title>Testing the configuration</title>
            <para>
                You should now be able to run Tomcat using the scripts we installed
                above. See the <ulink url="launch-overview.html">Launch Overview</ulink>
                section for an explanation of how the scripts work.  On NT, make sure
                that the installation works as a console application before attempting
                to run as a service.
            </para>
            <para>
                If you find any problems with this sample, please let us know so we can
                get them fixed.
            </para>
        </section>
    </section> 
</chapter>
